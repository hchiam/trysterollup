import {selfId as A,joinRoom as _} from'./trystero-nostr.0.20.0.min.js';var c=a=>typeof a==='function';const{keys:d}=Object;export class GameController{constructor({updateUi:B,keydownListeners:D={},buttonListeners:e={},joystickListeners:f={},gamepadConnectedCallback:C,gamepadDisconnectedCallback:_c,manuallyMapGamepadToActions:g=!1,hold3ButtonsFor3SecondsToRemapButtons:h=!1}){this.room=null;this.updateUi=B||function(){};this.localData={players:{[A]:{playerId:0}}};this.debug=!0;this.debugMore=!1;this.gamepads={};this.keydownListeners=D;this.buttonListeners=e;this.joystickListeners=f;this.gamepadConnectedCallback=C||function(){};this.gamepadDisconnectedCallback=_c||function(){};this.#originalButtonListeners={};for(let _a of d(this.buttonListeners))this.#originalButtonListeners[_a]=this.buttonListeners[_a];this.#hold3ButtonsFor3SecondsToRemapButtons=h;this.#manuallyMapGamepadToActions=g;this.listenersToRemap={};g&&this.manuallyRemapButtons();this.#sendData(this.localData);this.#initializeKeyboardSupport();this.#initializeGamepadSupport()}#sendData=()=>{};#onDataUpdate=()=>{};#originalButtonListeners={};#currentButton=null;#manuallyMapGamepadToActions=!1;#manuallyRemapLastButtonTimeout=null;#hold3ButtonsFor3SecondsToRemapButtons=!1;#remapButtonsHoldTimer=null;#remapButtonsDelayTimer=null;join(){this.debug&&console.log('join');this.room=_(...arguments);const[_A,_b]=this.room.makeAction('data');this.#sendData=_A;this.#onDataUpdate=_b;this.#initializeRoomEventListeners();return this.room}startGame(){this.update();return this}update(E=null){E&&(this.localData=E);this.updateUi();this.#sendData(this.localData);return this}updatePosition(aA=0,_B=0,_C=A){const{x,y}=this.localData.players[_C];this.localData.players[_C].x=x===void 0?aA:+x+ +aA;this.localData.players[_C].y=y===void 0?_B:+y+ +_B;this.update();return this}isHolding3ButtonsDown(){return (this.#hold3ButtonsFor3SecondsToRemapButtons&&this.getCurrentlyOnButtonsPerGamepad().some(aB=>aB.length===3))}isManuallyRemappingButtons(){var aC=d(this.listenersToRemap);return aC.length>0}manuallyRemapButtons(){this.#manuallyMapGamepadToActions=!0;this.listenersToRemap={};for(let aD of d(this.buttonListeners))this.listenersToRemap[`toRemap:${aD}`]=this.#originalButtonListeners[aD]}getCurrentlyOnButtonsPerGamepad(){return this.gamepads.map(gp=>gp.buttons.map((b,i)=>({i,on:b.pressed||b.touched})).filter(b=>b.on).map(b=>b.i))}#initializeRoomEventListeners(){this.#signalNewcomers();this.#listenForPeersSendingData();this.#listenForPeersLeaving()}#signalNewcomers(){this.room?.onPeerJoin(aE=>{this.#syncPlayerIdOfIncomingPeer(aE);this.debug&&console.log('onPeerJoin',aE);this.updateUi()})}#listenForPeersSendingData(){this.#onDataUpdate((aF,aG)=>{this.debugMore&&(console.log(`-----|\n\this.localData BEFORE:\n${JSON.stringify(this.localData)}`),console.log('#onDataUpdate data peerId',JSON.stringify(aF),aG));for(const x of Object.entries(aF))this.localData[x[0]]=x[1];this.#syncPlayerIdOfIncomingPeer(aG);this.debugMore&&console.log(`this.localData AFTER:\n${JSON.stringify(this.localData)}\n\n|-----`);this.updateUi()})}#syncPlayerIdOfIncomingPeer(aH){var aI=JSON.stringify(this.localData);!(aH in this.localData.players)&&(this.localData.players[aH]={playerId:0});var aJ=!isNaN(this.localData.players[aH].playerId)&&this.localData.players[aH].playerId===0;if(aJ){var _d=Math.max(...Object.values(this.localData.players).map(x=>isNaN(x.playerId)?0:+x.playerId));this.localData.players[aH].playerId=Math.max(_d+1,d(this.localData.players).length-1);this.#updateHost()}let _e=aJ||aI!==JSON.stringify(this.localData);_e&&this.#sendData(this.localData)}#listenForPeersLeaving(){this.room?.onPeerLeave(aK=>{delete this.localData.players[aK];this.debug&&console.log('onPeerLeave',aK);this.#updateHost();this.updateUi()})}#updateHost(){let aL=0;let aM=null;for(const aO of Object.entries(this.localData.players)){var aN=aO[1];aN.isHost=!1;var _D=aN.playerId>aL;_D&&(aL=aN.playerId,aM=aO[0])}this.localData.players[aM].isHost=!0;this.update()}#initializeKeyboardSupport(){document.querySelector('body').addEventListener('keydown',aP=>{switch(aP.key.toLowerCase()) {case 'arrowleft':case 'a':this.keydownListeners?.left?.(aP);break;case 'arrowright':case 'd':this.keydownListeners?.right?.(aP);break;case 'arrowup':case 'w':this.keydownListeners?.up?.(aP);break;case 'arrowdown':case 's':this.keydownListeners?.down?.(aP);break}})}#initializeGamepadSupport(){var aQ='getGamepads' in navigator;aQ&&(window.addEventListener('gamepadconnected',aR=>{if(this.debug)console.log('gamepad connected:',aR.gamepad);if(this.#isFunction(this.gamepadConnectedCallback))this.gamepadConnectedCallback(aR);setTimeout(()=>this.updateUi(),100)}),window.addEventListener('gamepaddisconnected',aS=>{if(this.debug)console.log('gamepad disconnected:',aS.gamepad);if(this.#isFunction(this.gamepadDisconnectedCallback))this.gamepadDisconnectedCallback(aS);setTimeout(()=>this.updateUi(),100)}),this.#pollGamepads(aT=>{if(aT?.length)this.#mapGamepadToActions(aT[0])}))}#pollGamepads(aU=()=>{}){this.gamepads=navigator.getGamepads().filter(Boolean);aU(this.gamepads);window.requestAnimationFrame(this.#pollGamepads.bind(this,aU))}#mapGamepadToActions(aV){if(!aV)return;var aW=aV.buttons;if(aW?.length)for(const[i,aZ] of aW.entries())if(aZ.pressed||aZ.touched){var aX=aZ;if(this.#manuallyMapGamepadToActions)if(this.isManuallyRemappingButtons()){var aY=d(this.listenersToRemap),_E=aY[0],F=this.listenersToRemap[_E];if(this.#currentButton!==aX){this.#currentButton=aX;this.buttonListeners[i]=F;aY.length===1?(clearTimeout(this.#manuallyRemapLastButtonTimeout),this.#manuallyRemapLastButtonTimeout=setTimeout(()=>delete this.listenersToRemap[_E],200)):(delete this.listenersToRemap[_E])}}if(!(this.#hold3ButtonsFor3SecondsToRemapButtons&&this.getCurrentlyOnButtonsPerGamepad().some(bA=>bA.length===3))){var G=this.buttonListeners[i];G?.(aX)}else this.#remapButtonsHoldTimer===null&&(this.#remapButtonsHoldTimer=setTimeout(()=>{clearTimeout(this.#remapButtonsDelayTimer);this.#remapButtonsDelayTimer=setTimeout(()=>{this.manuallyRemapButtons();clearTimeout(this.#remapButtonsDelayTimer);clearTimeout(this.#remapButtonsHoldTimer);this.#remapButtonsHoldTimer=null},0)},3000))}var H=aV.axes;if(H?.length)for(const[i,bB] of H.entries()){var I=this.joystickListeners[i];I?.(bB)}}#isFunction(bC){return (c(bC)&&!`${bC}`.startsWith('classs'))}}
