import {selfId as a,joinRoom as A} from'./trystero-nostr.0.20.0.min.js';const{keys:c}=Object;export class GameController{constructor({updateUi:_,keydownListeners:B={},buttonListeners:C={},joystickListeners:d={},generatingDocumentation:e=!1,manuallyMapGamepadToActions:f=!1,hold3ButtonsFor3SecondsToRemapButtons:g=!1}){this.room=null;this.updateUi=_||function(){};this.localData={players:{[a]:{playerId:0}}};this.debug=!0;this.debugMore=!1;this.gamepads={};this.keydownListeners=B;this.buttonListeners=C;this.joystickListeners=d;this.#originalButtonListeners={};for(let _a of c(this.buttonListeners))this.#originalButtonListeners[_a]=this.buttonListeners[_a];this.#hold3ButtonsFor3SecondsToRemapButtons=g;this.#manuallyMapGamepadToActions=f;this.listenersToRemap={};f&&this.manuallyRemapButtons();!e&&(this.#sendData(this.localData),this.#initializeKeyboardSupport(),this.#initializeGamepadSupport())}#sendData=()=>{};#getData=()=>{};#originalButtonListeners={};#currentButton=null;#manuallyMapGamepadToActions=!1;#manuallyRemapLastButtonTimeout=null;#hold3ButtonsFor3SecondsToRemapButtons=!1;#remapButtonsHoldTimer=null;#remapButtonsDelayTimer=null;join(){this.debug&&console.log('join');this.room=A(...arguments);const[D,_b]=this.room.makeAction('data');this.#sendData=D;this.#getData=_b;this.#initializeRoomEventListeners();return this.room}startGame(){this.update();return this}update(_A=null){_A&&(this.localData=_A);this.updateUi();this.#sendData(this.localData);return this}updatePosition(E=0,_B=0,_c=a){const{x,y}=this.localData.players[_c];this.localData.players[_c].x=x===void 0?E:+x+ +E;this.localData.players[_c].y=y===void 0?_B:+y+ +_B;this.update();return this}isHolding3ButtonsDown(){return (this.#hold3ButtonsFor3SecondsToRemapButtons&&this.getCurrentlyOnButtonsPerGamepad().some(aA=>aA.length===3))}isManuallyRemappingButtons(){var aB=c(this.listenersToRemap);return aB.length>0}manuallyRemapButtons(){this.#manuallyMapGamepadToActions=!0;this.listenersToRemap={};for(let aC of c(this.buttonListeners))this.listenersToRemap[`toRemap:${aC}`]=this.#originalButtonListeners[aC]}getCurrentlyOnButtonsPerGamepad(){return this.gamepads.map(gp=>gp.buttons.map((b,i)=>({i,on:b.pressed||b.touched})).filter(b=>b.on).map(b=>b.i))}#initializeRoomEventListeners(){this.#signalNewcomers();this.#listenForPeersSendingData();this.#listenForPeersLeaving()}#signalNewcomers(){this.room?.onPeerJoin(aD=>{this.#syncPlayerIdOfIncomingPeer(aD);this.debug&&console.log('onPeerJoin',aD);this.updateUi()})}#listenForPeersSendingData(){this.#getData((aE,aF)=>{this.debugMore&&(console.log(`-----|\n\this.localData BEFORE:\n${JSON.stringify(this.localData)}`),console.log('#getData data peerId',JSON.stringify(aE),aF));for(const x of Object.entries(aE))this.localData[x[0]]=x[1];this.#syncPlayerIdOfIncomingPeer(aF);this.debugMore&&console.log(`this.localData AFTER:\n${JSON.stringify(this.localData)}\n\n|-----`);this.updateUi()})}#syncPlayerIdOfIncomingPeer(aG){var aH=JSON.stringify(this.localData);!(aG in this.localData.players)&&(this.localData.players[aG]={playerId:0});var _C=!isNaN(this.localData.players[aG].playerId)&&this.localData.players[aG].playerId===0;if(_C){var _d=Math.max(...Object.values(this.localData.players).map(x=>isNaN(x.playerId)?0:+x.playerId));this.localData.players[aG].playerId=Math.max(_d+1,c(this.localData.players).length-1);this.#updateHost()}let _e=_C||aH!==JSON.stringify(this.localData);_e&&this.#sendData(this.localData)}#listenForPeersLeaving(){this.room?.onPeerLeave(aI=>{delete this.localData.players[aI];this.debug&&console.log('onPeerLeave',aI);this.#updateHost();this.updateUi()})}#updateHost(){let aJ=0;let aK=null;for(const aM of Object.entries(this.localData.players)){var aL=aM[1];aL.isHost=!1;var _D=aL.playerId>aJ;_D&&(aJ=aL.playerId,aK=aM[0])}this.localData.players[aK].isHost=!0;this.update()}#initializeKeyboardSupport(){document.querySelector('body').addEventListener('keydown',aN=>{switch(aN.key.toLowerCase()) {case 'arrowleft':case 'a':this.keydownListeners?.left?.(aN);break;case 'arrowright':case 'd':this.keydownListeners?.right?.(aN);break;case 'arrowup':case 'w':this.keydownListeners?.up?.(aN);break;case 'arrowdown':case 's':this.keydownListeners?.down?.(aN);break}})}#initializeGamepadSupport(){var aO='getGamepads' in navigator;aO&&(window.addEventListener('gamepadconnected',aP=>{if(this.debug)console.log('gamepad connected:',aP.gamepad);setTimeout(()=>this.updateUi(),100)}),window.addEventListener('gamepaddisconnected',aQ=>{if(this.debug)console.log('gamepad disconnected:',aQ.gamepad);setTimeout(()=>this.updateUi(),100)}),this.#pollGamepads(aR=>{if(aR?.length)this.#mapGamepadToActions(aR[0])}))}#pollGamepads(aS=()=>{}){this.gamepads=navigator.getGamepads().filter(Boolean);aS(this.gamepads);window.requestAnimationFrame(this.#pollGamepads.bind(this,aS))}#mapGamepadToActions(aT){if(!aT)return;var aU=aT.buttons;if(aU?.length)for(const[i,aX] of aU.entries())if(aX.pressed||aX.touched){var aV=aX;if(this.#manuallyMapGamepadToActions)if(this.isManuallyRemappingButtons()){var aW=c(this.listenersToRemap),_E=aW[0],F=this.listenersToRemap[_E];if(this.#currentButton!==aV){this.#currentButton=aV;this.buttonListeners[i]=F;aW.length===1?(clearTimeout(this.#manuallyRemapLastButtonTimeout),this.#manuallyRemapLastButtonTimeout=setTimeout(()=>delete this.listenersToRemap[_E],200)):(delete this.listenersToRemap[_E])}}if(!(this.#hold3ButtonsFor3SecondsToRemapButtons&&this.getCurrentlyOnButtonsPerGamepad().some(aY=>aY.length===3))){var G=this.buttonListeners[i];G?.(aV)}else this.#remapButtonsHoldTimer===null&&(this.#remapButtonsHoldTimer=setTimeout(()=>{clearTimeout(this.#remapButtonsDelayTimer);this.#remapButtonsDelayTimer=setTimeout(()=>{this.manuallyRemapButtons();clearTimeout(this.#remapButtonsDelayTimer);clearTimeout(this.#remapButtonsHoldTimer);this.#remapButtonsHoldTimer=null},0)},3000))}var h=aT.axes;if(h?.length)for(const[i,aZ] of h.entries()){var I=this.joystickListeners[i];I?.(aZ)}}}
